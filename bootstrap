## This is the test of bootstrap using wangyang dataset

setwd("C:\\Users\\WL\\Desktop\\wangliang\\medicine")

wy_data <- read.csv(file = "primary cohort mast_1_o.dat", sep = "\t", header = T, stringsAsFactor = F)


#################################################################################################################
## calculation of AIC
#################################################################################################################


## group mod_mLNR 

library(boot)
library(survival)

d_data <- wy_data[,c(6,9,11,12,13,18,20,25,26,27)]

rsq <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS == 1)
  fit <- coxph(y ~ mLNRstage, data = data_na)
  return(extractAIC(fit))
}


set.seed(1234)

results <- boot(data = d_data, statistic = rsq, R = 1000)

pdf("mLNR.pdf")
plot(results, index=2)
dev.off()


## group mod_Nstage

rsq1 <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS == 1)
  fit <- coxph(y ~ Nstage, data = data_na)
  return(extractAIC(fit))
}


set.seed(1234)

results1 <- boot(data = d_data, statistic = rsq1, R = 1000)

pdf("Nstage.pdf")
plot(results1, index=2)
dev.off()

t.test(results$t[,2],results1$t[,2])




###############
##  ds





###############
## group AJCC


rsq_AJCC <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS == 1)
  fit <- coxph(y ~ AJCCstage, data = data_na)
  return(extractAIC(fit))
}


set.seed(1234)

results_AJCC <- boot(data = d_data, statistic = rsq_AJCC, R = 1000)


pdf("AJCC.pdf")
plot(results_AJCC, index = 2)
dev.off()




###############
## group TNR


rsq_TNR <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS == 1)
  fit <- coxph(y ~ TNR分组, data = data_na)
  return(extractAIC(fit))
}


set.seed(1234)

results_TNR <- boot(data = d_data, statistic = rsq_TNR, R = 1000)


pdf("TNR.pdf")
plot(results_TNR, index = 2)
dev.off()


t.test(results_AJCC$t[,2], results_TNR$t[,2])


######################################################################################################
##  DSS10 == 1



setwd("C:\\Users\\WL\\Desktop\\wangliang\\medicine")

wy_data <- read.csv(file = "primary cohort mast_1_o.dat", sep = "\t", header = T, stringsAsFactor = F)



## group mod_mLNR 

library(boot)
library(survival)

d_data <- wy_data[,c(6,9,11,12,13,18,20,25,26,27,33)]

rsq <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS10 == 1)
  fit <- coxph(y ~ mLNRstage, data = data_na)
  return(extractAIC(fit))
}


set.seed(1234)

results <- boot(data = d_data, statistic = rsq, R = 1000)

pdf("mLNR_DSS10.pdf")
plot(results, index=2)
dev.off()


## group mod_Nstage

rsq1 <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS10 == 1)
  fit <- coxph(y ~ Nstage, data = data_na)
  return(extractAIC(fit))
}


set.seed(1234)

results1 <- boot(data = d_data, statistic = rsq1, R = 1000)

pdf("Nstage_DSS10.pdf")
plot(results1, index=2)
dev.off()

t.test(results$t[,2],results1$t[,2])









###############
## group AJCC


rsq_AJCC <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS10 == 1)
  fit <- coxph(y ~ AJCCstage, data = data_na)
  return(extractAIC(fit))
}


set.seed(1234)

results_AJCC <- boot(data = d_data, statistic = rsq_AJCC, R = 1000)


pdf("AJCC_DSS10.pdf")
plot(results_AJCC, index = 2)
dev.off()




###############
## group TNR


rsq_TNR <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS10 == 1)
  fit <- coxph(y ~ TNR分组, data = data_na)
  return(extractAIC(fit))
}


set.seed(1234)

results_TNR <- boot(data = d_data, statistic = rsq_TNR, R = 1000)


pdf("TNR_DSS10.pdf")
plot(results_TNR, index = 2)
dev.off()


t.test(results_AJCC$t[,2], results_TNR$t[,2])




#################################################################################################################
## calculation of C-index
#################################################################################################################



setwd("C:\\Users\\WL\\Desktop\\wangliang\\medicine")

wy_data <- read.csv(file = "primary cohort mast_1_o.dat", sep = "\t", header = T, stringsAsFactor = F)


## group mod_mLNR 

library(boot)
library(survival)
library(Hmisc)



d_data <- wy_data[,c(6,9,11,12,13,18,20,25,26,27)]


#######################################################################


rsq <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS == 1)
  fit <- coxph(y ~ mLNRstage, data = data_na)
  fp <- predict(fit)
  cindex.orig <- 1-rcorr.cens(fp,y)
  return(cindex.orig[1])
}


set.seed(1234)

results <- boot(data = d_data, statistic = rsq, R = 1000)

pdf("mLNR_Cindex.pdf")
plot(results, index=1)
dev.off()


#######################################################################




rsq1 <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS == 1)
  fit <- coxph(y ~ Nstage, data = data_na)
  fp <- predict(fit)
  cindex.orig <- 1-rcorr.cens(fp,y)
  return(cindex.orig[1])
}


set.seed(1234)

results1 <- boot(data = d_data, statistic = rsq1, R = 1000)

pdf("Nstage_Cindex.pdf")
plot(results1, index=1)
dev.off()


t.test(results$t, results1$t)





#########################################################################


rsq_AJCC <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS == 1)
  fit <- coxph(y ~ AJCCstage, data = data_na)
  fp <- predict(fit)
  cindex.orig <- 1-rcorr.cens(fp,y)
  return(cindex.orig[1])
}


set.seed(1234)

results_AJCC <- boot(data = d_data, statistic = rsq_AJCC, R = 1000)

pdf("AJCC_Cindex.pdf")
plot(results_AJCC, index=1)
dev.off()


#######################################################################




rsq1_TNR <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d)
  y <- Surv(data_na$Time, data_na$DSS == 1)
  fit <- coxph(y ~ TNR分组, data = data_na)
  fp <- predict(fit)
  cindex.orig <- 1-rcorr.cens(fp,y)
  return(cindex.orig[1])
}


set.seed(1234)

results_TNR <- boot(data = d_data, statistic = rsq1_TNR, R = 1000)

pdf("TNR_Cindex.pdf")
plot(results_TNR, index=1)
dev.off()


t.test(results_AJCC$t, results_TNR$t)










#################################################################################################################
## calculation of AUC
#################################################################################################################



setwd("C:\\Users\\WL\\Desktop\\wangliang\\medicine")

wy_data <- read.csv(file = "primary cohort mast_1_o.dat", sep = "\t", header = T, stringsAsFactor = F)

d_data <- wy_data[,c(6,9,11,12,13,18,20,25,26,27)]


## group mod_mLNR 

library(boot)
library(survival)
library(pROC)



#######################################################################


rsq <- function(data, indices) {
  d <- data[indices, ]
  data_na <- na.omit(d_data[d_data$DSS == 1, ])
  ##y <- Surv(data_na$Time)
  fit <- coxph(Surv(data_na$Time) ~ mLNRstage, data = data_na)
  fp <- predict(fit,type=c("survival"))
  data_na$pred <- fp
  g <- roc(fp ~ mLNRstage, data = data_na)  
  return(cindex.orig[1])
}


set.seed(1234)

results <- boot(data = d_data, statistic = rsq, R = 1000)

pdf("mLNR_Cindex.pdf")
plot(results, index=1)
dev.off()








mydata <- read.csv("http://www.ats.ucla.edu/stat/data/binary.csv")  
mylogit <- glm(admit ~ gre, data = mydata, family = "binomial")  
summary(mylogit)  
prob=predict(mylogit,type=c("response"))  
mydata$prob=prob  
library(pROC)  
g <- roc(admit ~ prob, data = mydata)  
plot(g)  




#################################################
##test AUC


set.seed(666)
age <- rnorm(400, 50, 10)
bp  <- rnorm(400,120, 15)
d.time <- rexp(400)
cens   <- runif(400,.5,2)
death  <- d.time <= cens
d.time <- pmin(d.time, cens)



fit <- coxph(Surv(d.time,death) ~ age + bp)
summary(fit) 
# Concordance = 0.502  (se = 0.019 ) 


AUC2 <- survivalROC(Stime=d.time, status=death, marker = eta, predict.time =  265, method="KM")       
                    
AUC2$AUC





#################################################
##test C-index


y <- Surv(data_na$Time, data_na$DSS == 1)
fit <- coxph(y ~ AJCCstage, data = data_na)
fp <- predict(fit)###模型的预测值
cindex.orig=1-rcorr.cens(fp,y) 
cindex.orig[1]


  


y <- Surv(data_na$Time, data_na$DSS == 1)
fit1 <- coxph(y ~ TNR分组, data = data_na)
fp1 <- predict(fit1)###模型的预测值
cindex.orig1=1-rcorr.cens(fp1,y) 
cindex.orig1[1]



















