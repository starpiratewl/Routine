#############################################################################################################################
## single sample t-test
#############################################################################################################################

## z test when z score = -1, z scores = (sample_mean - population_mean)/standard error
pnorm(-1, mean = 0, sd = 1)
## 0.1586553

## one side hypothesis testing, the result is the same as the result on page 183
pnorm(31, mean = 30, sd = 0.6, lower.tail = F)
##[1] 0.04779035

## two sided hypothesis testing, the result is the same as the result on page 184
pnorm(98.4, mean = 98.6, sd = 0.2)
pvalue <- 2 * pnorm(98.4, mean = 98.6, sd = 0.2)
pvalue
##[1] 0.3173105

## the above testing is assume the population variance is known, but it is rarely the case when we practice.
## alomost in all the cases, we have t estiamte the population variance using the sample variance
## when we use the sample variance, we calculate the t-scores and use the t-distribution\
## t_score = (sample_mean - population_mean)/sample_sd/sqrt(sample_size)
## when we have the t_score, we can use pt() fucntion in R to calculate the probability
## This is the single sample t-test, the following result is the same as the result on page 189
pt(5.33, df = 199, lower.tail = F)
##[1] 1.324778e-07

## when we don't know the t-score in advance, we can calculate
library(MASS)
t.test(Pima.tr$bmi, mu = 30, alternative = "two.sided")
##        One Sample t-test
##
##data:  Pima.tr$bmi
##t = 5.3291, df = 199, p-value = 2.661e-07
##alternative hypothesis: true mean is not equal to 30
##95 percent confidence interval:
## 31.45521 33.16479
##sample estimates:
##mean of x 
##    32.31 

## if we need one side t-test, we should set the alternative parameter to "greater" or "less"
## the following we set "greater" because the sample mean is greater than mu
library(MASS)
t.test(Pima.tr$bmi, mu = 30, alternative = "greater")
##        One Sample t-test
##
##data:  Pima.tr$bmi
##t = 5.3291, df = 199, p-value = 1.331e-07
##alternative hypothesis: true mean is greater than 30
##95 percent confidence interval:
## 31.59367      Inf
##sample estimates:
##mean of x 
##    32.31 

## we can set the confidential level by the conf.level parameters
## notice that if we don't set the alternative parameter, its default value is "two.sided"
library(MASS)
t.test(Pima.tr$bmi, mu = 30, conf.level = 0.9)
##        One Sample t-test
##
##data:  Pima.tr$bmi
##t = 5.3291, df = 199, p-value = 2.661e-07
##alternative hypothesis: true mean is not equal to 30
##90 percent confidence interval:
## 31.59367 33.02633
##sample estimates:
##mean of x 
##    32.31

## test of the normality
## the H0 is assume the data is normally distributed
library(MASS)
shapiro.test(Pima.tr$bmi)
##        Shapiro-Wilk normality test
##
##data:  Pima.tr$bmi
##W = 0.99104, p-value = 0.2523
## the pvalue is large, so we can not reject the H0 hypothesis, the data is normally distributed, the following histogram validate
## the normal distribution too.

hist(Pima.tr$bmi, freq = FALSE, xlab = "BMI", ylab = "Density", col = "red", main = "Density histogram of BMI")

 
#############################################################################################################################
## two sample t-test
#############################################################################################################################

## to see if there is a difference between two groups
head(birthwt)
##   low age lwt race smoke ptl ht ui ftv  bwt
##85   0  19 182    2     0   0  0  1   0 2523
##86   0  33 155    3     0   0  0  0   3 2551
##87   0  20 105    1     1   0  0  0   1 2557
##88   0  21 108    1     1   0  0  1   2 2594
##89   0  18 107    1     1   0  0  1   0 2600
##91   0  21 124    3     0   0  0  0   0 2622

t.test(bwt ~ smoke, mu = 0, alternative = "two.sided", data = birthwt)
##        Welch Two Sample t-test
##
##data:  bwt by smoke
##t = 2.7299, df = 170.1, p-value = 0.007003
##alternative hypothesis: true difference in means is not equal to 0
##95 percent confidence interval:
##  78.57486 488.97860
##sample estimates:
##mean in group 0 mean in group 1 
##       3055.696        2771.919 


## paired t-test
setwd("D:\\importantbk\\learning\\data\\R_documentation\\biostatistics_with_R")

Platelet <- read.csv(file = "Platelet.txt", sep = "\t", stringsAsFactors = F)

t.test(Platelet$Before, Platelet$After, alternative = "less", paired = T)
##         Paired t-test
##
## data:  Platelet$Before and Platelet$After
## t = -4.2716, df = 10, p-value = 0.0008164
## alternative hypothesis: true difference in means is less than 0
## 95 percent confidence interval:
##       -Inf -5.913967
## sample estimates:
## mean of the differences 
##               -10.27273 

## pay close attention here, if our experiment design is paired, the data analysis should use paired t test, or the result will
## be completely different. Check the following result and compare it with the result above, the only difference is the parameter
## "paired = T", but the conclusion is almost reverse.
t.test(Platelet$Before, Platelet$After, alternative = "less")
##        Welch Two Sample t-test
##
##data:  Platelet$Before and Platelet$After
##t = -1.4164, df = 19.516, p-value = 0.08621
##alternative hypothesis: true difference in means is less than 0
##95 percent confidence interval:
##     -Inf 2.251395
##sample estimates:
##mean of x mean of y 
## 42.18182  52.45455 




#############################################################################################################################
## inference about the relationship between two binary variables
#############################################################################################################################
library(MASS)
head(birthwt)

table(birthwt$smoke, birthwt$low)
##     0  1
##  0 86 29
##  1 44 30


prop.table(table(birthwt$smoke, birthwt$low))
##           0         1
##  0 0.4550265 0.1534392
##  1 0.2328042 0.1587302


######################################
## generate the frequecies table
######################################

options(digits=3)
a=c(20,23,20,24,23,21,22,25,26,20,21,21,22,22,23,22,22,24,25,21,22,21,24,23)
b=table(a)
b1=as.vector(b)
c=prop.table(table(a))
c1=as.vector(c)
x=data.frame(b1,c1)
dimnames(x)=list(c('20','21','22','23','24','25','26'),c("频数","频率"))
x
> x
   频数   频率
20    3 0.1250
21    5 0.2083
22    6 0.2500
23    4 0.1667
24    3 0.1250
25    2 0.0833
26    1 0.0417


test <- table(birthwt$smoke, birthwt$low)
dimnames(test)=list(c("Nonsmoke","smoke"),c("Notlow","Low"))
test
##          Notlow Low
## Nonsmoke     86  29
## smoke        44  30

cor.test(test[,1], test[,2])
## Error in cor.test.default(test[, 1], test[, 2]) : 有限值的观察量不够

## so here we can not use an existing R function to perform the hypothesis testing
## we can build one by ourself


tab <- test

## calcualte the proportion and the 
u1 <- tab[1,2]/(tab[1,1] + tab[1,2])
u2 <- tab[2,2]/(tab[2,1] + tab[2,2])
u12 <- u1 - u2
SE12 <-sqrt(u1*(1-u1)/sum(tab[1,1],tab[1,2]) + u2*(1-u2)/sum(tab[2,1],tab[2,2]))
z12 <- u12/SE12
pvalue <- 2 * pnorm(z12, mean = 0, sd = 1)
## [1] 0.02855152

## the pvalue is small, so we can reject the H0 that u12 = 0 and conclude that the differect is statistically significant, that means
## the two variables are related








#############################################################################################################################
## inference regarding the linear relationship between two numerical variables
#############################################################################################################################

install.packages("mfp")
library(mfp)
data(bodyfat)
head(bodyfat)
##   case brozek siri density age weight height neck chest abdomen   hip thigh knee ankle biceps forearm wrist
## 1    1   12.6 12.3  1.0708  23 154.25  67.75 36.2  93.1    85.2  94.5  59.0 37.3  21.9   32.0    27.4  17.1
## 2    2    6.9  6.1  1.0853  22 173.25  72.25 38.5  93.6    83.0  98.7  58.7 37.3  23.4   30.5    28.9  18.2
## 3    3   24.6 25.3  1.0414  22 154.00  66.25 34.0  95.8    87.9  99.2  59.6 38.9  24.0   28.8    25.2  16.6
## 4    4   10.9 10.4  1.0751  26 184.75  72.25 37.4 101.8    86.4 101.2  60.1 37.3  22.8   32.4    29.4  18.2
## 5    5   27.8 28.7  1.0340  24 184.25  71.25 34.4  97.3   100.0 101.9  63.2 42.2  24.0   32.2    27.7  17.7
## 6    6   20.6 20.9  1.0502  24 210.25  74.75 39.0 104.5    94.4 107.8  66.0 42.0  25.6   35.7    30.6  18.8

cor.test(bodyfat$siri, bodyfat$abdomen, alternative = "greater")
##        Pearson's product-moment correlation
##
##data:  bodyfat$siri and bodyfat$abdomen
##t = 22.112, df = 250, p-value < 2.2e-16
##alternative hypothesis: true correlation is greater than 0
##95 percent confidence interval:
## 0.77505 1.00000
##sample estimates:
##      cor 
##0.8134323 


## the following function give the cor matrix
cor(bodyfat[,c("abdomen","siri")])
##           abdomen      siri
## abdomen 1.0000000 0.8134323
## siri    0.8134323 1.0000000







